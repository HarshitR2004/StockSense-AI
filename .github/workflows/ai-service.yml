name: AI Service CI/CD

on:
  push:
    branches: [ main ]
    paths:
      - 'stocksense/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SSH Client
        run: sudo apt-get install -y openssh-client

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "\
            export AWS_REGION=${{ secrets.AWS_REGION }} && \
            export ECR_REPO=${{ secrets.ECR_REPO }} && \
            aws ecr get-login-password --region \$AWS_REGION | docker login --username AWS --password-stdin \$ECR_REPO && \
            docker pull \$ECR_REPO:latest && \
            docker stop stocksense-ai || true && docker rm stocksense-ai || true && \
            docker run -d -p 8001:8080 --name stocksense-ai \$ECR_REPO:latest \
          "
